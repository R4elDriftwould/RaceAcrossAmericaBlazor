@page "/tracker/{RaceId:int}"
@using Microsoft.AspNetCore.Authorization
@using RaceAcrossAmerica.Data
@using RaceAcrossAmerica.Services
@rendermode InteractiveServer
@inject RaceManagerService RaceService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>Race Tracker</PageTitle>

@if (_race == null)
{
    <MudContainer Class="mt-5">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText>Loading Race Tracker...</MudText>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pb-5">
        <div class="d-flex justify-content-between align-items-center mb-2 mt-2">
            <MudText Typo="Typo.h4">@_race.Title</MudText>
            <MudChip T="string" Color="Color.Primary">@_race.TotalDistanceMiles Miles</MudChip>
        </div>

        <MudGrid>
            <MudItem xs="12" lg="9">

                <div class="map-wrapper">

                    <MudPaper Elevation="3" Class="map-layer overflow-hidden">

                        <img src="/images/us_map.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8; user-select: none;" />

                        <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                            @if (_sortedCheckpoints.Count > 1)
                            {
                                for (int i = 0; i < _sortedCheckpoints.Count - 1; i++)
                                {
                                    var c1 = _sortedCheckpoints[i];
                                    var c2 = _sortedCheckpoints[i + 1];
                                    <line x1="@(c1.MapPositionX)%" y1="@(c1.MapPositionY)%"
                                          x2="@(c2.MapPositionX)%" y2="@(c2.MapPositionY)%"
                                          style="stroke: #d13438; stroke-width: 2; stroke-dasharray: 4 4; opacity: 0.6;" />
                                }
                            }

                            @if (_selectedStudentId.HasValue && _selectedStudentPath.Any())
                            {
                                for (int i = 0; i < _selectedStudentPath.Count - 1; i++)
                                {
                                    var p1 = _selectedStudentPath[i];
                                    var p2 = _selectedStudentPath[i + 1];
                                    <line x1="@(p1.X)%" y1="@(p1.Y)%"
                                          x2="@(p2.X)%" y2="@(p2.Y)%"
                                          style="stroke: #1976d2; stroke-width: 3; stroke-linecap: round; opacity: 0.9;" />
                                }
                            }
                        </svg>

                        @foreach (var cp in _sortedCheckpoints)
                        {
                            <div @onclick="() => SelectCheckpoint(cp)" @onclick:stopPropagation="true"
                                 class="map-pin-container checkpoint-hitbox"
                                 style="left: @(cp.MapPositionX)%; top: @(cp.MapPositionY)%; z-index: 20;">
                                <div class="pin-checkpoint"></div>
                            </div>

                            <div style="position: absolute;
                                                left: @(cp.MapPositionX)%;
                                                top: @(cp.MapPositionY + 4)%;
                                                transform: translateX(-50%);
                                                font-size: 10px; font-weight: bold; color: #333;
                                                z-index: 20;
                                                text-shadow: 1px 1px 2px white; pointer-events: none;">
                                @cp.Name
                            </div>
                        }

                        @foreach (var p in _filteredParticipants)
                        {
                            var pos = CalculateStudentPosition(p.LapsCompleted);
                            bool isSelected = _selectedStudentId == p.StudentId;

                            // --- NEW: HIDE OTHERS LOGIC ---
                            // If a student is selected, and this specific 'p' is NOT the selected one, skip it.
                            if (_selectedStudentId.HasValue && !isSelected) continue;
                            // ------------------------------

                            string zIndex = isSelected ? "30" : "15";

                            <div @onclick="() => SelectStudent(p.StudentId)" @onclick:stopPropagation="true"
                                 class="map-pin-container @(isSelected ? "selected-container" : "")"
                                 style="left: @(pos.X)%; top: @(pos.Y)%; z-index: @zIndex;">
                                <div class="@(isSelected ? "pin-student-selected" : "pin-student")"></div>
                            </div>
                        }
                    </MudPaper>

                    @if (_selectedCheckpoint != null)
                    {
                        <MudPaper Class="pa-2 absolute-popup" Elevation="4"
                                  Style="@GetSmartPopupStyle(_selectedCheckpoint)">

                            <div class="d-flex justify-content-between align-center mb-1">
                                <MudText Typo="Typo.body2" Style="font-weight:bold; font-size: 0.9em;">@_selectedCheckpoint.Name</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="ClearCheckpointSelection" />
                            </div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@_selectedCheckpoint.DistanceFromStart miles</MudText>

                            @if (!string.IsNullOrEmpty(_selectedCheckpoint.Description))
                            {
                                <MudText Typo="Typo.caption" Class="mt-1 mb-2 d-block fst-italic">@_selectedCheckpoint.Description</MudText>
                            }

                            <MudDivider Class="my-1" />

                            <MudText Typo="Typo.caption" Class="d-block mb-1">Students Here:</MudText>
                            @if (_studentsAtCheckpoint.Any())
                            {
                                <div style="max-height: 60px; overflow-y: auto;">
                                    @foreach (var s in _studentsAtCheckpoint)
                                    {
                                        <MudText Typo="Typo.caption" Class="d-block">@s.Student?.FullName (@(s.LapsCompleted* MilesPerLap) mi)</MudText>
                                    }
                                </div>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Class="text-muted">None.</MudText>
                            }
                        </MudPaper>
                    }
                </div>

                <div class="d-flex gap-3 justify-center mt-2">
                    <div class="d-flex align-center"><div style="width: 10px; height: 10px; background: #d13438; border-radius: 50%; margin-right: 5px;"></div> <MudText Typo="Typo.caption">Checkpoint</MudText></div>
                    <div class="d-flex align-center"><div style="width: 10px; height: 10px; background: #1976d2; border-radius: 50%; margin-right: 5px;"></div> <MudText Typo="Typo.caption">Student</MudText></div>
                    <div class="d-flex align-center"><div style="width: 10px; height: 10px; background: #ffc107; border-radius: 50%; margin-right: 5px;"></div> <MudText Typo="Typo.caption">Selected</MudText></div>
                </div>
            </MudItem>

            <MudItem xs="12" lg="3">
                <MudPaper Class="pa-3" Elevation="3" Height="100%">
                    <MudText Typo="Typo.h6" Class="mb-2">Leaderboard</MudText>

                    <MudSelect T="string" Label="Filter Group" @bind-Value="_filterGroup" Dense="true" Variant="Variant.Outlined" Class="mb-3">
                        <MudSelectItem Value="@("All")">All Groups</MudSelectItem>
                        @foreach (var g in _availableGroups)
                        {
                            <MudSelectItem Value="@g">@g</MudSelectItem>
                        }
                    </MudSelect>

                    @if (_selectedStudentId.HasValue)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" FullWidth="true" Class="mb-2" OnClick="ClearStudentSelection">
                            Clear Selection
                        </MudButton>
                    }

                    <div style="max-height: 500px; overflow-y: auto;">
                        <MudList T="string" Clickable="true" Dense="true">
                            @foreach (var p in _filteredParticipants)
                            {
                                bool isSelected = _selectedStudentId == p.StudentId;

                                <MudListItem OnClick="() => SelectStudent(p.StudentId)"
                                             Class="@(isSelected ? "mud-theme-warning" : "")">
                                    <div class="d-flex justify-content-between align-center">
                                        <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">
                                            <MudText Typo="Typo.body2"><b>@p.Student?.FullName</b></MudText>
                                            <MudText Typo="Typo.caption">@p.Student?.Group</MudText>
                                        </div>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@p.LapsCompleted</MudChip>
                                    </div>

                                    @if (isSelected)
                                    {
                                        <div class="d-flex gap-2 mt-2 justify-end">
                                            <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="@((e) => HandleRemoveLap(p.StudentId))">-</MudButton>
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small" OnClick="@((e) => HandleAddLap(p.StudentId))">+ Lap</MudButton>
                                        </div>
                                    }
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    </div>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <MudPaper Class="mt-4 pa-4" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-2">Manage Laps (All Students)</MudText>

            <MudTable T="RaceParticipant" Items="_sortedParticipants" Hover="true" Dense="true" Striped="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Group</MudTh>
                    <MudTh>Laps</MudTh>
                    <MudTh>Distance</MudTh>
                    <MudTh>Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">@context.Student?.FullName</MudTd>
                    <MudTd DataLabel="Group">@context.Student?.Group</MudTd>
                    <MudTd DataLabel="Laps"><b>@context.LapsCompleted</b></MudTd>
                    <MudTd DataLabel="Distance">@((context.LapsCompleted * MilesPerLap)) mi</MudTd>
                    <MudTd DataLabel="Action">
                        <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Color="Color.Error" Size="Size.Small" OnClick="@(() => HandleRemoveLap(context.StudentId))" />
                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Color="Color.Success" Size="Size.Medium" OnClick="@(() => HandleAddLap(context.StudentId))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

        </MudPaper>
    </MudContainer>

    <style>
        .map-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            margin-bottom: 10px;
        }

        .map-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e9ecef;
            touch-action: manipulation;
        }

        /* --- PINS --- */
        .map-pin-container {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            /* DEFAULT: Students are easier to click (24px) */
            width: 12px;
            height: 12px;
        }

        /* Tighter Hitbox for Checkpoints */
        .checkpoint-hitbox {
            width: 12px;
            height: 12px;
        }

        /* --- VISUALS --- */
        .pin-checkpoint {
            width: 11px;
            height: 11px;
            background-color: #d13438;
            border: 1px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pin-student {
            width: 10px;
            height: 10px;
            background-color: #1976d2;
            border: 1px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .pin-student-selected {
            width: 13px;
            height: 13px;
            background-color: #ffc107;
            border: 1px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px #ffc107;
            z-index: 50;
        }

        /* --- POPUP (Free Floating) --- */
        .absolute-popup {
            position: absolute;
            width: 200px;
            z-index: 1000; /* Float above everything */
            transition: top 0.2s, left 0.2s;
        }

        /* --- MOBILE/TABLET ADJUSTMENTS (960px) --- */
        @@media (max-width: 960px) {
            /* Students: Bigger touch target, smaller dot */
            .map-pin-container {
                width: 9px;
                height: 9px;
            }

            .pin-student {
                width: 7px;
                height: 7px;
                border: 1px solid white;
            }

            .pin-student-selected {
                width: 10px;
                height: 10px;
                border: 1px solid white;
            }
            /* Checkpoints: Tighter touch target, small dot */
            .checkpoint-hitbox {
                width: 8px;
                height: 8px;
                
            }

            .pin-checkpoint {
                width: 6px;
                height: 6px;
                border: 1px solid white;
            }
            /* Shrink Popup */
            .absolute-popup {
                width: 150px !important;
                font-size: 0.75rem !important;
            }
        }
    </style>
}

@code {
    [Parameter] public int RaceId { get; set; }

    private Race? _race;
    private const double MilesPerLap = 50.0;

    private string _filterGroup = "All";
    private List<string> _availableGroups = new();
    private int? _selectedStudentId = null;

    private Checkpoint? _selectedCheckpoint = null;
    private List<RaceParticipant> _studentsAtCheckpoint = new();
    private List<Checkpoint> _sortedCheckpoints = new();
    private List<(double X, double Y)> _selectedStudentPath = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _race = await RaceService.GetRaceByIdAsync(RaceId);
        if (_race == null) { NavManager.NavigateTo("/"); return; }

        _sortedCheckpoints = _race.Checkpoints.OrderBy(c => c.DistanceFromStart).ToList();

        _availableGroups = _race.RaceParticipants
            .Select(p => p.Student?.Group ?? "Unassigned")
            .Distinct().OrderBy(g => g).ToList();

        if (_selectedStudentId.HasValue) UpdateSelectedPath();

        if (_selectedCheckpoint != null) SelectCheckpoint(_selectedCheckpoint);
    }

    private IEnumerable<RaceParticipant> _filteredParticipants
    {
        get
        {
            if (_race == null) return Enumerable.Empty<RaceParticipant>();
            var query = _race.RaceParticipants.AsEnumerable();
            if (_filterGroup != "All")
            {
                query = query.Where(p => (p.Student?.Group ?? "Unassigned") == _filterGroup);
            }
            return query.OrderByDescending(p => p.LapsCompleted);
        }
    }

    private IEnumerable<RaceParticipant> _sortedParticipants =>
        _filteredParticipants.OrderBy(p => p.Student?.LastName);

    private void SelectStudent(int studentId)
    {
        _selectedStudentId = studentId;
        _selectedCheckpoint = null;
        UpdateSelectedPath();
    }

    private void ClearStudentSelection()
    {
        _selectedStudentId = null;
        _selectedStudentPath.Clear();
    }

    private void SelectCheckpoint(Checkpoint cp)
    {
        _selectedCheckpoint = cp;
        _selectedStudentId = null;
        _selectedStudentPath.Clear();

        _studentsAtCheckpoint = new List<RaceParticipant>();
        if (_race == null) return;

        foreach (var p in _race.RaceParticipants)
        {
            double studentMiles = p.LapsCompleted * MilesPerLap;
            var lastPassed = _sortedCheckpoints
                .Where(c => c.DistanceFromStart <= studentMiles)
                .OrderByDescending(c => c.DistanceFromStart)
                .FirstOrDefault();

            if (lastPassed != null && lastPassed.Id == cp.Id)
            {
                _studentsAtCheckpoint.Add(p);
            }
            else if (lastPassed == null && cp.DistanceFromStart == 0)
            {
                _studentsAtCheckpoint.Add(p);
            }
        }
    }

    private void ClearCheckpointSelection() => _selectedCheckpoint = null;

    private async Task HandleAddLap(int studentId)
    {
        await RaceService.AddLapAsync(RaceId, studentId);
        Snackbar.Add("Lap Added!", Severity.Success, config => { config.ShowCloseIcon = false; config.VisibleStateDuration = 1000; });
        await LoadData();
    }

    private async Task HandleRemoveLap(int studentId)
    {
        await RaceService.RemoveLapAsync(RaceId, studentId);
        Snackbar.Add("Lap Removed", Severity.Warning, config => { config.ShowCloseIcon = false; config.VisibleStateDuration = 1000; });
        await LoadData();
    }

    // --- SMART POPUP POSITIONING ---
    private string GetSmartPopupStyle(Checkpoint cp)
    {
        // 1. Base Position: Place popup at the checkpoint's X/Y
        string style = $"left: {cp.MapPositionX}%; top: {cp.MapPositionY}%;";

        // 2. Determine Offsets
        string transX = "-50%";
        string transY = "-105%";

        // EDGE DETECTION LOGIC
        if (cp.MapPositionX < 30) transX = "0%";
        else if (cp.MapPositionX > 70) transX = "-100%";

        if (cp.MapPositionY < 40)
        {
            transY = "25px"; // Push 25px BELOW the dot
        }

        // 3. Apply Transform
        style += $"transform: translate({transX}, {transY});";
        return style;
    }

    private void UpdateSelectedPath()
    {
        _selectedStudentPath.Clear();
        if (!_selectedStudentId.HasValue || _race == null) return;

        var participant = _race.RaceParticipants.FirstOrDefault(p => p.StudentId == _selectedStudentId);
        if (participant == null) return;

        double currentMiles = participant.LapsCompleted * MilesPerLap;

        if (_sortedCheckpoints.Any())
        {
            var start = _sortedCheckpoints.First();
            _selectedStudentPath.Add((start.MapPositionX, start.MapPositionY));

            foreach (var cp in _sortedCheckpoints.Skip(1))
            {
                if (cp.DistanceFromStart <= currentMiles)
                {
                    _selectedStudentPath.Add((cp.MapPositionX, cp.MapPositionY));
                }
                else { break; }
            }
        }
        var currentPos = CalculateStudentPosition(participant.LapsCompleted);
        _selectedStudentPath.Add((currentPos.X, currentPos.Y));
    }

    private (double X, double Y) CalculateStudentPosition(int laps)
    {
        double currentMiles = laps * MilesPerLap;
        if (!_sortedCheckpoints.Any()) return (50, 50);

        if (currentMiles <= _sortedCheckpoints.First().DistanceFromStart)
            return (_sortedCheckpoints.First().MapPositionX, _sortedCheckpoints.First().MapPositionY);

        if (currentMiles >= _sortedCheckpoints.Last().DistanceFromStart)
            return (_sortedCheckpoints.Last().MapPositionX, _sortedCheckpoints.Last().MapPositionY);

        var prevCp = _sortedCheckpoints.LastOrDefault(c => c.DistanceFromStart <= currentMiles);
        var nextCp = _sortedCheckpoints.FirstOrDefault(c => c.DistanceFromStart > currentMiles);

        if (prevCp == null || nextCp == null) return (50, 50);

        double segmentLength = nextCp.DistanceFromStart - prevCp.DistanceFromStart;
        double distanceIntoSegment = currentMiles - prevCp.DistanceFromStart;
        double ratio = segmentLength > 0 ? distanceIntoSegment / segmentLength : 0;

        double x = prevCp.MapPositionX + (nextCp.MapPositionX - prevCp.MapPositionX) * ratio;
        double y = prevCp.MapPositionY + (nextCp.MapPositionY - prevCp.MapPositionY) * ratio;

        return (x, y);
    }
}