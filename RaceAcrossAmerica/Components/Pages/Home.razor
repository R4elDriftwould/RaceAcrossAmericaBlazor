@page "/"
@using Microsoft.AspNetCore.Authorization
@using RaceAcrossAmerica.Data
@using RaceAcrossAmerica.Services
@attribute [Authorize]
@inject RaceManagerService RaceService
@inject NavigationManager NavManager

<PageTitle>Race Manager</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h3" GutterBottom="true">Race Manager</MudText>
        </MudItem>

        <MudItem xs="12" md="12">
            <MudPaper Class="pa-4 my-4" Elevation="3">
                <MudText Typo="Typo.h5" GutterBottom="true">Create New Race</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_newRace.Title" Label="Race Title" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6" md="4">
                        <MudNumericField @bind-Value="_newRace.TotalDistanceMiles" Label="Total Miles" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="6" md="2" Class="d-flex align-center">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="HandleCreateRace">Create</MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            @if (_races == null)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else if (_races.Count == 0)
            {
                <MudAlert Severity="Severity.Info">No races found. Create a new one above!</MudAlert>
            }
            else
            {
                <MudTable Items="_races" Hover="true" Striped="true" Elevation="3">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Distance</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Action</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Name">@context.Title</MudTd>
                        <MudTd DataLabel="Distance">@context.TotalDistanceMiles miles</MudTd>
                        <MudTd DataLabel="Status">
                            @if (context.IsActive)
                            {
                                <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                            }
                            else
                            {
                                <MudChip T="string" Color="Color.Dark" Size="Size.Small">Finished</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Action">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Href="@($"/race/{context.Id}")">Manage</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code{
    // Create variable for Race List
    // Default create new Race object
    // Function to Load Races using GetAllRacesAsync using RaceService
    // Function to handle creating a new race using RaceService.CreateRaceAsync
        // After creating a new race reload the race list w/ LoadRace()
    // OnInitialized function to onload populate Race List

    private List<Race>? _races;

    private Race _newRace = new Race { Title = "", IsActive = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadRace();
    }

    private async Task LoadRace()
    {
        _races = await RaceService.GetAllRacesAsync();
    }

    private async Task HandleCreateRace()
    {
        if (string.IsNullOrEmpty(_newRace.Title)) return;

        await RaceService.CreateRaceAsync(_newRace);

        // Reset form
        _newRace = new Race { Title = "", IsActive = true };

        await LoadRace();
    }
}

