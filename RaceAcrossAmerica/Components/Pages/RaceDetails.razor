@page "/race/{RaceId:int}"
@using Microsoft.AspNetCore.Authorization
@using RaceAcrossAmerica.Data
@using RaceAcrossAmerica.Services
@attribute [Authorize]
@inject RaceManagerService RaceService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>Race Details</PageTitle>

@if (_race == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <MudText Typo="Typo.h3">@_race.Title</MudText>
                <MudChip T="string" Color="Color.Primary" Class="mt-2">@_race.TotalDistanceMiles Miles</MudChip>
            </div>
            <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Launch" Href="@($"/tracker/{_race.Id}")" Target="_blank">
                Launch Tracker
            </MudButton>
        </div>

        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4 mb-4" Elevation="3">
                    <MudText Typo="Typo.h5" GutterBottom="true">Checkpoint Manager</MudText>

                    <MudPaper Class="mb-4 overflow-hidden position-relative" Style="width: 100%; aspect-ratio: 16/9; background-color: #e9ecef; border: 1px solid #ddd;">
                        <img src="/images/us_map.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;" />

                        @foreach (var cp in _race.Checkpoints)
                        {
                            <MudTooltip Text="@($"{cp.Name} ({cp.DistanceFromStart} mi)")">
                                <div style="position: absolute;
                                                    left: @(cp.MapPositionX)%;
                                                    top: @(cp.MapPositionY)%;
                                                    width: 12px; height: 12px;
                                                    background-color: #1976d2;
                                                    border: 2px solid white;
                                                    border-radius: 50%;
                                                    transform: translate(-50%, -50%);
                                                    z-index: 5;
                                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                </div>
                            </MudTooltip>
                        }

                        <div style="position: absolute;
                                        left: @(_newCheckpoint.MapPositionX)%;
                                        top: @(_newCheckpoint.MapPositionY)%;
                                        width: 16px; height: 16px;
                                        background-color: #00e676;
                                        border: 2px solid white;
                                        border-radius: 50%;
                                        transform: translate(-50%, -50%);
                                        z-index: 10;
                                        box-shadow: 0 0 8px #00e676;">
                        </div>

                        <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            X: @_newCheckpoint.MapPositionX% | Y: @_newCheckpoint.MapPositionY%
                        </div>
                    </MudPaper>

                    <MudCard Outlined="true" Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-2">Add New Checkpoint</MudText>
                            <MudGrid>
                                <MudItem xs="12" sm="8">
                                    <MudTextField @bind-Value="_newCheckpoint.Name" Label="Checkpoint Name" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                </MudItem>
                                <MudItem xs="12" sm="4">
                                    <MudNumericField @bind-Value="_newCheckpoint.DistanceFromStart" Label="Miles" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudTextField @bind-Value="_newCheckpoint.Description" Label="Description (Popup Info)" Variant="Variant.Outlined" Margin="Margin.Dense" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="_newCheckpoint.MapPositionX" Label="Map X %" Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="100" />
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudNumericField @bind-Value="_newCheckpoint.MapPositionY" Label="Map Y %" Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="100" />
                                </MudItem>
                                <MudItem xs="12" sm="6" Class="d-flex align-end">
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" OnClick="HandleAddCheckpoint">Save Checkpoint</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>

                    @if (_race.Checkpoints.Any())
                    {
                        <MudTable Items="_race.Checkpoints.OrderBy(c => c.DistanceFromStart)" Hover="true" Dense="true" Striped="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Location</MudTh>
                                <MudTh>Distance</MudTh>
                                <MudTh>Coords</MudTh>
                                <MudTh>Action</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.Name</MudTd>
                                <MudTd>@context.DistanceFromStart mi</MudTd>
                                <MudTd>(@context.MapPositionX%, @context.MapPositionY%)</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => HandleDeleteCheckpoint(context.Id))" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning">No checkpoints set. Add the Start Line (0 miles)!</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3">
                    <MudText Typo="Typo.h5" Class="mb-3">Student Roster</MudText>

                    <MudGrid Class="mb-3">
                        <MudItem xs="8">
                            <MudSelect T="int" @bind-Value="_selectedStudentId" Label="Select Student" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                                <MudSelectItem Value="0">Choose...</MudSelectItem>
                                @foreach (var student in _allStudents)
                                {
                                    <MudSelectItem Value="@student.Id">@student.FullName</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="HandleAddStudentToRace" Class="mt-1">Add</MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (_race.RaceParticipants.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var p in _race.RaceParticipants)
                            {
                                <MudListItem>
                                    <div class="d-flex justify-content-between">
                                        <MudText>@p.Student?.FullName</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">@p.LapsCompleted Laps</MudChip>
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudText Class="text-muted">No students enrolled yet.</MudText>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
}


@code {
    // Get RaceId from parameter
    // Logic: Fetch _race based on RaceId using RaceService.GetRaceByIdAsync
    [Parameter]
    public int RaceId { get; set; }

    private Race? _race;

    // Initialize this with default 50,50 so the dot appears in the middle at first
    private Checkpoint _newCheckpoint = new() { MapPositionX = 50, MapPositionY = 50 };

    // Task 6 or 5
    // Add Student List on Load
    // Select student dropdown
    // Handle Adding Student to Race

    private List<Student> _allStudents = new();
    private int _selectedStudentId;

    protected override async Task OnInitializedAsync()
    {
        await LoadRaceData();

        _allStudents = await RaceService.GetAllStudentsAsync();
    }

    private async Task LoadRaceData()
    {
        _race = await RaceService.GetRaceByIdAsync(RaceId);
        if (_race == null) NavManager.NavigateTo("/");
    }

    private async Task HandleAddCheckpoint()
    {
        if (string.IsNullOrWhiteSpace(_newCheckpoint.Name))
        {
            Snackbar.Add("Checkpoint Name is required", Severity.Warning);
            return;
        }

        // Link the checkpoint to THIS race
        _newCheckpoint.RaceId = RaceId;

        // Save
        await RaceService.AddCheckpointAsync(_newCheckpoint);
        Snackbar.Add("Checkpoint Saved", Severity.Success);

        // Reset the form (Reset X/Y to center for the next one)
        _newCheckpoint = new Checkpoint { MapPositionX = 50, MapPositionY = 50 };

        // Refresh the list
        await LoadRaceData();
    }

    private async Task HandleDeleteCheckpoint(int id)
    {
        await RaceService.DeleteCheckpointAsync(id);
        Snackbar.Add("Checkpoint Deleted", Severity.Error);
        await LoadRaceData();
    }

    // Task 6 - Handle Adding Student to RaceParticipants for Race
    private async Task HandleAddStudentToRace()
    {
        // Validation
        if (_selectedStudentId == 0) return;
        // Run the service to add the student to Student Table
        await RaceService.AddStudentToRaceAsync(RaceId, _selectedStudentId);
        Snackbar.Add("Student Added to Race", Severity.Success);

        _selectedStudentId = 0;

        await LoadRaceData();
    }
}
